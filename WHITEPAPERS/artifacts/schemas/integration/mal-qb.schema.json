{
  "$schema": "https://json-schema.org/draft/2020-12/schema",
  "$id": "https://asi-t2.org/schemas/integration/mal-qb.schema.json",
  "title": "MAL-QB Service Contract",
  "description": "MAL-QB (Bit Cubic; non-quantumised) service contract schema for discrete 3D optimization",
  "type": "object",
  "required": ["service_id", "version", "layer", "topics", "optimization", "utcs"],
  "properties": {
    "service_id": {
      "type": "string",
      "pattern": "^MAL-QB-[A-Z0-9_-]{3,}$",
      "description": "Unique MAL-QB service identifier"
    },
    "version": {
      "type": "string",
      "pattern": "^\\d+\\.\\d+\\.\\d+$",
      "description": "Service version following semantic versioning"
    },
    "layer": {
      "type": "string",
      "const": "QB",
      "description": "Bridge layer designation (must be QB)"
    },
    "topics": {
      "type": "object",
      "required": ["subscribe", "publish"],
      "properties": {
        "subscribe": {
          "type": "array",
          "items": {
            "type": "string",
            "pattern": "^map/1/control/[A-Z0-9_-]+/[A-Z]{3}/QUBITS/QB/QB$"
          }
        },
        "publish": {
          "type": "array",
          "items": {
            "type": "string",
            "pattern": "^map/1/telemetry/[A-Z0-9_-]+/[A-Z]{3}/QUBITS/QB/QB$"
          },
          "minItems": 1
        }
      }
    },
    "optimization": {
      "type": "object",
      "required": ["role", "method", "safety"],
      "properties": {
        "role": {
          "type": "string",
          "const": "advisory",
          "description": "QB role must be advisory only"
        },
        "method": {
          "type": "string",
          "enum": ["QUBO", "Ising", "annealing", "variational", "hybrid"],
          "description": "Optimization method"
        },
        "safety": {
          "type": "object",
          "required": ["max_age_s", "fallback", "accept_predicates"],
          "properties": {
            "max_age_s": {
              "type": "number",
              "minimum": 0.1,
              "maximum": 60,
              "description": "Maximum age for QB solutions before discard"
            },
            "fallback": {
              "type": "string",
              "description": "Fallback mechanism when QB unavailable or solutions rejected"
            },
            "accept_predicates": {
              "type": "array",
              "items": {
                "type": "string",
                "description": "Safety predicate for accepting QB solutions"
              },
              "minItems": 1,
              "description": "Predicates that must be satisfied to accept QB solutions"
            }
          }
        },
        "solvers": {
          "type": "array",
          "items": {
            "type": "object",
            "required": ["solver_id", "backend"],
            "properties": {
              "solver_id": {
                "type": "string",
                "description": "Unique solver identifier"
              },
              "backend": {
                "type": "string",
                "enum": ["simulator", "quantum-inspired", "classical-optimizer"],
                "description": "Solver backend type (NOT quantum hardware)"
              },
              "parameters": {
                "type": "object",
                "properties": {
                  "num_reads": {
                    "type": "integer",
                    "minimum": 1,
                    "description": "Number of solution samples"
                  },
                  "chain_strength": {
                    "type": "number",
                    "description": "Chain strength for embedding"
                  },
                  "annealing_time_us": {
                    "type": "number",
                    "minimum": 1,
                    "description": "Annealing time in microseconds"
                  }
                }
              }
            }
          }
        }
      }
    },
    "utcs": {
      "type": "object",
      "required": ["require_signature", "record_backend"],
      "properties": {
        "require_signature": {
          "type": "boolean",
          "const": true,
          "description": "Require signatures on QB solutions"
        },
        "record_backend": {
          "type": "boolean",
          "const": true,
          "description": "Record all QB operations to backend"
        },
        "bundle_format": {
          "type": "string",
          "enum": ["UTCS-v5.0"],
          "description": "UTCS bundle format version"
        }
      }
    },
    "interfaces": {
      "type": "object",
      "properties": {
        "optimize_qb": {
          "type": "object",
          "properties": {
            "input": {
              "type": "object",
              "properties": {
                "problem": {
                  "type": "object",
                  "description": "QUBO/Ising problem definition"
                },
                "constraints": {
                  "type": "object",
                  "description": "Physical/safety constraints"
                },
                "objective": {
                  "type": "string",
                  "enum": ["minimize", "maximize"],
                  "description": "Optimization objective"
                }
              }
            },
            "output": {
              "type": "object",
              "properties": {
                "solutions": {
                  "type": "array",
                  "description": "Array of solution candidates"
                },
                "energies": {
                  "type": "array",
                  "description": "Energy values for each solution"
                },
                "status": {
                  "type": "string",
                  "enum": ["optimal", "feasible", "timeout", "error"]
                },
                "predicates_satisfied": {
                  "type": "boolean",
                  "description": "Whether safety predicates are satisfied"
                },
                "timestamp": {
                  "type": "string",
                  "format": "date-time"
                }
              }
            }
          }
        }
      }
    },
    "safety_notes": {
      "type": "string",
      "description": "QB is NON-QUANTUM and advisory only. Solutions must pass accept_predicates and be validated by CB layer before use in safety-critical systems."
    },
    "performance": {
      "type": "object",
      "properties": {
        "max_optimization_time_s": {
          "type": "number",
          "minimum": 0.1,
          "maximum": 300,
          "description": "Maximum time for optimization"
        }
      }
    },
    "compliance": {
      "type": "object",
      "properties": {
        "standards": {
          "type": "array",
          "items": {
            "type": "string",
            "enum": ["IEC-62443", "ISO-27001"]
          }
        },
        "certification_notes": {
          "type": "string",
          "description": "QB is advisory and not subject to DO-178C certification"
        }
      }
    }
  }
}
