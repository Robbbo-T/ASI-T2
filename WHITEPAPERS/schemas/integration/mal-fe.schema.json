{
  "$schema": "https://json-schema.org/draft/2020-12/schema",
  "$id": "https://asi-t2.org/schemas/integration/mal-fe.schema.json",
  "title": "MAL-FE Service Contract",
  "description": "MAL-FE (Federation Entanglement / Contracting) service contract schema for inter-system coordination",
  "type": "object",
  "required": ["service_id", "version", "layer", "topics", "federation", "utcs"],
  "properties": {
    "service_id": {
      "type": "string",
      "pattern": "^MAL-FE-[A-Z0-9_-]{3,}$",
      "description": "Unique MAL-FE service identifier"
    },
    "version": {
      "type": "string",
      "pattern": "^\\d+\\.\\d+\\.\\d+$",
      "description": "Service version following semantic versioning"
    },
    "layer": {
      "type": "string",
      "const": "FE",
      "description": "Bridge layer designation (must be FE)"
    },
    "topics": {
      "type": "object",
      "required": ["subscribe", "publish"],
      "properties": {
        "subscribe": {
          "type": "array",
          "items": {
            "type": "string",
            "pattern": "^map/1/control/[A-Z0-9_-]+/[A-Z]{3,5}/[A-Z0-9_]+/FE/FE$"
          }
        },
        "publish": {
          "type": "array",
          "items": {
            "type": "string",
            "pattern": "^map/1/telemetry/[A-Z0-9_-]+/[A-Z]{3,5}/ELEMENTS/FE/FE$"
          },
          "minItems": 1
        }
      }
    },
    "federation": {
      "type": "object",
      "required": ["coordination_mode", "consensus"],
      "properties": {
        "coordination_mode": {
          "type": "string",
          "enum": ["centralized", "distributed", "hierarchical"],
          "description": "Federation coordination mode"
        },
        "consensus": {
          "type": "object",
          "required": ["algorithm", "timeout_s"],
          "properties": {
            "algorithm": {
              "type": "string",
              "enum": ["raft", "paxos", "pbft", "deterministic"],
              "description": "Consensus algorithm"
            },
            "timeout_s": {
              "type": "number",
              "minimum": 0.1,
              "maximum": 300,
              "description": "Consensus timeout in seconds"
            },
            "quorum": {
              "type": "number",
              "minimum": 0.5,
              "maximum": 1,
              "description": "Quorum fraction required for consensus"
            }
          }
        },
        "slo": {
          "type": "object",
          "description": "Service Level Objectives",
          "properties": {
            "availability": {
              "type": "number",
              "minimum": 0,
              "maximum": 1,
              "description": "Required availability (0-1)"
            },
            "latency_p99_ms": {
              "type": "number",
              "description": "99th percentile latency in ms"
            },
            "throughput_min": {
              "type": "number",
              "description": "Minimum throughput"
            }
          }
        }
      }
    },
    "utcs": {
      "type": "object",
      "required": ["require_signature", "record_backend"],
      "properties": {
        "require_signature": {
          "type": "boolean",
          "const": true,
          "description": "Require signatures on federation decisions"
        },
        "record_backend": {
          "type": "boolean",
          "const": true,
          "description": "Record all coordination events"
        }
      }
    },
    "interfaces": {
      "type": "object",
      "properties": {
        "coordinate": {
          "type": "object",
          "properties": {
            "input": {
              "type": "object",
              "properties": {
                "participants": {"type": "array", "items": {"type": "string"}},
                "objective": {"type": "string"},
                "constraints": {"type": "object"}
              }
            },
            "output": {
              "type": "object",
              "properties": {
                "plan": {"type": "object"},
                "consensus_reached": {"type": "boolean"},
                "timestamp": {"type": "string", "format": "date-time"}
              }
            }
          }
        }
      }
    },
    "security": {
      "type": "object",
      "properties": {
        "eem_policy": {
          "type": "string",
          "description": "Reference to MAL-EEM policy document"
        },
        "mutual_auth": {
          "type": "boolean",
          "description": "Require mutual authentication between participants"
        }
      }
    },
    "compliance": {
      "type": "object",
      "properties": {
        "standards": {
          "type": "array",
          "items": {
            "type": "string",
            "enum": ["IEC-62443", "ISO-27001", "ARP4754A"]
          }
        }
      }
    }
  }
}
